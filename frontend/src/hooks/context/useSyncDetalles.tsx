// src/hooks/useSyncDetalles.ts
import { useEffect } from "react";
import { useFormikContext } from "formik";
import isEqual from "lodash/isEqual";
import type {
  CobranzasFormValues,
  DetallePagoRegistroRequest,
  DetallePagoRegistroRequestExt,
} from "../../types/types";

/**
 * Función de mapeo que transforma cada detalle pendiente obtenido en la deuda
 * al formato que usa el formulario.
 * Se utiliza 'mensualidadId' (si existe) como identificador principal; de lo contrario se usa 'id'.
 *
 * - Se asigna 'cuotaOCantidad' (o "1" por defecto).
 * - Se asigna 'valorBase' a partir de 'valorBase' o 'montoOriginal' o 0.
 * - Se preserva 'aCobrar' si ya existe en el formulario; si no, se toma de 'importePendiente' o 0.
 *
 * Se agrega la propiedad extra 'autoGenerated' para identificar que este detalle fue generado automáticamente.
 */
const mapDetallePagos = (
  detallePendientes: any[],
  currentDetalles: DetallePagoRegistroRequest[]
): DetallePagoRegistroRequestExt[] => {
  console.log(
    "[mapDetallePagos] Iniciando mapeo de detalles pendientes:",
    detallePendientes
  );
  const mapped = detallePendientes.map((det) => {
    const idKey = det.mensualidadId ?? det.id;
    const existing = currentDetalles.find((d) => d.id === idKey);
    const mappedDetail: DetallePagoRegistroRequestExt = {
      autoGenerated: true,
      id: idKey,
      descripcionConcepto: det.descripcionConcepto || "",
      conceptoId: det.conceptoId ?? null,
      subConceptoId: det.subConceptoId ?? null,
      cuotaOCantidad: det.cuotaOCantidad ?? "1",
      valorBase: det.valorBase ?? det.montoOriginal ?? 0,
      bonificacionId: det.bonificacionId ?? null,
      recargoId: det.recargoId ?? null,
      importePendiente: det.importePendiente,
      aCobrar: existing?.aCobrar ?? det.importePendiente ?? 0,
      cobrado: det.cobrado ?? false,
      mensualidadId: det.mensualidadId ?? null,
      matriculaId: det.matriculaId ?? null,
      stockId: det.stockId ?? null,
    };
    console.log("[mapDetallePagos] Detalle mapeado:", mappedDetail);
    return mappedDetail;
  });
  console.log("[mapDetallePagos] Resultado mapeo completo:", mapped);
  return mapped;
};

/**
 * Hook para sincronizar los detalles de pago del formulario con los detalles pendientes obtenidos en deudaData.
 * Se priorizan los detalles manuales, descartando aquellos automáticos duplicados.
 */
export const useSyncDetalles = (
  deudaData: DeudasPendientesResponse,
  ultimoPago: any
) => {
  const { values, setFieldValue } = useFormikContext<CobranzasFormValues>();

  useEffect(() => {
    console.log("[useSyncDetalles] Ejecutando hook con deudaData:", deudaData);
    console.log(
      "[useSyncDetalles] Valores actuales del formulario (detallePagos):",
      values.detallePagos
    );
    console.log(
      "[useSyncDetalles] Valores actuales del formulario (autoRemoved):",
      values.autoRemoved
    );

    // 1. Mapear los detalles pendientes obtenidos en la deuda al formato del formulario.
    const autoDetails = mapDetallePagos(
      deudaData.detallePagosPendientes || [],
      values.detallePagos
    );
    console.log(
      "[useSyncDetalles] Detalles automáticos mapeados:",
      autoDetails
    );

    // 2. Filtrar los detalles automáticos que hayan sido removidos manualmente.
    const removedIds = new Set(values.autoRemoved || []);
    const autoDetailsFiltered = autoDetails.filter((det) => {
      if (det.id != null) {
        const include = !removedIds.has(det.id) && Number(det.aCobrar) !== 0;
        console.log(
          `[useSyncDetalles] Auto detalle id=${det.id} ${
            include ? "incluido" : "excluido"
          } por removedIds y aCobrar`
        );
        return include;
      }
      const include = Number(det.aCobrar) !== 0;
      console.log(
        `[useSyncDetalles] Auto detalle sin id, ${
          include ? "incluido" : "excluido"
        } por aCobrar`
      );
      return include;
    });
    console.log(
      "[useSyncDetalles] Detalles automáticos filtrados:",
      autoDetailsFiltered
    );

    // 3. Extraer los detalles manuales ya presentes en el formulario (no generados automáticamente).
    const manualDetails = values.detallePagos.filter(
      (det) => !(det as any).autoGenerated
    );
    console.log("[useSyncDetalles] Detalles manuales actuales:", manualDetails);

    // 4. Si existen manuales, priorizarlos y descartar automáticos duplicados.
    let mergedDetails;
    if (manualDetails.length > 0) {
      // Obtener IDs de los detalles manuales.
      const manualIds = new Set(
        manualDetails.filter((det) => det.id != null).map((det) => det.id)
      );
      console.log(
        "[useSyncDetalles] IDs de detalles manuales:",
        Array.from(manualIds)
      );
      const finalAutoDetails = autoDetailsFiltered.filter((autoDet) => {
        if (autoDet.id != null) {
          const include = !manualIds.has(autoDet.id);
          if (!include) {
            console.log(
              `[useSyncDetalles] Auto detalle id=${autoDet.id} descartado porque ya existe manual.`
            );
          }
          return include;
        }
        // Para detalles sin ID, comparar campos clave.
        const exists = manualDetails.some(
          (manDet) =>
            manDet.descripcionConcepto === autoDet.descripcionConcepto &&
            manDet.valorBase === autoDet.valorBase
        );
        if (exists) {
          console.log(
            "[useSyncDetalles] Auto detalle sin id descartado por coincidencia de campos."
          );
        }
        return !exists;
      });
      console.log(
        "[useSyncDetalles] Detalles automáticos finales después de filtrar duplicados:",
        finalAutoDetails
      );
      // Fusionar manuales y aquellos automáticos que no están duplicados.
      mergedDetails = [...manualDetails, ...finalAutoDetails];
      console.log(
        "[useSyncDetalles] Fusionando manuales y automáticos no duplicados:",
        mergedDetails
      );
    } else {
      // Si no hay manuales, usar los automáticos filtrados.
      mergedDetails = autoDetailsFiltered;
      console.log(
        "[useSyncDetalles] No hay detalles manuales; usando automáticos:",
        mergedDetails
      );
    }

    // 5. Si la lista final difiere de la actual, actualizar el formulario.
    if (!isEqual(mergedDetails, values.detallePagos)) {
      console.log(
        "[useSyncDetalles] La lista final difiere de la actual. Actualizando 'detallePagos' a:",
        mergedDetails
      );
      setFieldValue("detallePagos", mergedDetails);
    } else {
      console.log(
        "[useSyncDetalles] La lista final es igual a la actual. No se actualiza."
      );
    }
  }, [
    deudaData,
    ultimoPago,
    setFieldValue,
    values.detallePagos,
    values.autoRemoved,
  ]);
};
